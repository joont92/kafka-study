# 메시지 전송 방법
위에서 언급한 `acks` 옵션을 어떻게 사용하느냐에 따라 카프카로 메시지를 전송할 때 메시지 손실 여부와 메시지 전송 속도등이 달라지게 된다  

### 메시지 손실 가능성이 높지만 빠른 전송이 필요한 경우
옵션을 `acks=0` 으로 설정하면 된다  
카프카로부터 응답을 받지 않겠다는 뜻인데,  
이 말인 즉 프로듀서가 카프카에게 메시지를 보내면서 정상 수신을 확인하지 않고 자신의 다음 메시지가 준비되면 계속해서 카프카로 메시지를 전송하는 방식이다(UDP 처럼)  

응답을 받지 않고 계속해서 메시지를 전송하다보니 속도는 가장 빠르지만, 메시지를 정확하게 받았는지 확인하는 플로우가 없으므로 중간에 메시지가 유실될 수 있다  
그렇다고 메시지가 막 엄청나게 유실된다는 소리는 아니고, 장애 상황시에 메시지 손실 가능성이 높은 편이라고 보는것이 좋다  

### 메시지 손실 가능성이 적고 적당한 속도의 전송이 필요한 경우
위의 방법과 달리, 프로듀서가 카프카로 메시지를 보낸 후 카프카가 메시지를 잘 받았는지 응답(acks)을 받아 확인한다  
응답 대기시간이 생기므로 메시지 전송 속도는 위의 방식보다 약간 떨어지게 된다  
이 방식을 사용하려면 옵션을 `acks=1` 로 설정하면 된다  

하지만 이 방법도 100% 메시지 손실을 보장해주는 방법은 아닌데,  
이는 `acks=1` 속성이 응답을 받는 브로커는 리더 1대뿐이기 때문이다  

![acks=1](../img/kafka_acks_1.png)  

보다시피 **클라이언트에게 ack를 보내는 시점이 팔로워가 리더로부터 데이터를 복제해가는 시점보다 빠르다**  

이러한 특징때문에 아래와 같은 플로우를 통해 데이터가 유실될 수 있다  
1. 메시지를 받은 리더 브로커가 프로듀서에게 ack 를 보냄(3번)
2. 팔로워에서 데이터를 복제해가기 전에 리더에 장애가 발생해서 리더가 다운됨
3. 팔로워 중 하나가 새로운 리더로 승격됨
4. 리더로부터 메시지를 복제하지 못한 상태에서 승격되었으므로 중간 메시지가 유실되었음

하지만 이는 아주 예외적인 경우에 발생하는 현상이므로, 특별한 이유 없으면 `acks=1` 옵션을 설정해서 사용하는 것을 추천한다고 한다  
(logstash, filebeat 등의 프로듀서에도 acks 기본값을 1로 사용하고 있다)  

### 전송 속도는 느리지만 메시지 손실이 없어야 하는 경우
카프카에서는 위의 방식보다 더 강력한 메시지 무손실을 보장할 수 있는 `acks=all(또는 acks=-1)` 을 제공한다  
위처럼 메시지를 보내고 응답을 받은 뒤 다시 메시지를 보내는 방식 자체는 동일한데,  
`acks=1` 의 경우 리더로부터만 응답을 받으면 다음 메시지를 보냈던 반면 `acks=all`의 경우 팔로워까지 응답을 받아야 다음 메시지를 보낼 수 있다  
이로 인해 무손실은 완벽하게 보장되나, 속도는 `acks=1` 보다 더 떨어지게 된다  

이 옵션을 사용할때는 단순히 이 옵션만 설정해선 안되고 브로커의 `min.insync.replicas` 설정도 같이 조정해줘야 한다  
이는 `실제 체크할 브로커의 개수`를 뜻한다고 보면 되는데,  
`acks=all` 이라고 해서 리플리케이션 팩터 개수만큼 acks 를 받는것이 아니라, `min.insync.replicas` 개수만큼만 acks 를 받는다는 뜻이다  

아파치 카프카 문서에서는 손실없는 메시지 전송을 위한 조건으로
- 프로듀서의 acks : all
- 브로커의 min.insync.replicas : 2
- 토픽의 replication factor : 3

을 권장하고 있다  

위 설정을 간단하게 설명하면,  
**토픽은 3개의 브로커에서 리플리케이션이 되고 있지만, 실제로는 2개의 브로커로부터만 ask를 받으면 다음 메시지를 전송한다** 라는 뜻이 된다  

> `min.insync.replicas`의 값을 3으로 설정하지 않는 이유는,  
> replication factor 가 3으로 설정된 상황에서 한개의 브로커에 장애가 발생할 경우  
> 브로커에서 메시지를 받아도 `min.insync.replicas` 의 개수가 충족되지 않기 때문에 프로듀서로 acks 를 보내주지 못하는 상황이 발생하기 떄문이다  